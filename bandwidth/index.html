<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Bandwidth vs. Time Per Host</title>
		<script type="text/javascript" src="d3.v3.min.js"></script>
        <script src="topojson.v0.min.js"></script>
		<style type="text/css">
            body {
                margin: 0;
            }

            .axis path,
            .axis line {
                    fill: none;
                    stroke: grey;
                    shape-rendering: crispEdges;
            }

            .connect {
                    fill: none;
                    stroke: black;
                    opacity: 0.3;
            }

            text .up,
            #plot .up {
                fill: red;
                opacity: 0.5;
                stroke: none;
            }

            text .dn,
            #plot .dn {
                fill: blue;
                opacity: 0.5;
                stroke: none;
            }

            .up {
                stroke: red;
                stroke-opacity: 0.5;
                stroke-width: 1;
                fill: none;
            }

            .dn {
                stroke: blue;
                stroke-opacity: 0.5;
                stroke-width: 1;
                fill: none;
            }

            .label {
                    font-family: sans-serif;
                    font-size: 12px;
            }
            .axis text {
                    font-family: sans-serif;
                    font-size: 10px;
            }

            .xaxis text {
                    font-weight: bold;
                    font-size: 11px;
            }

            #subnet_controls {
                font-family: sans-serif;
                margin-left: 45px;
            }

            #map path {
                fill: #CCC;
            }

            #map circle {
                fill: #333;
                opacity: 0.4;
            }

		</style>
	</head>
	<body>
        <svg></svg>
        <div id="subnet_controls">
          <button disabled name="button">Reset</button>
          Group IPs by subnet mask:
          <input name="mode" type="radio" value="16" id="subnet_16"><label for="subnet_16"> /16</label>
          <input name="mode" type="radio" value="24" id="subnet_24"><label for="subnet_24"> /24</label>
          <input name="mode" type="radio" value="32" id="subnet_32" checked><label for="subnet_32"> /32</label>
        </div>
		<script type="text/javascript">

            var datafile = "data/bandwidth.0-239.s",
                densityfile = "data/bandwidth_density.0-239.s",
                geoIPfile = "data/geoIPs.json"

			var w = 1300;
			var h = 600;
            var leftroom = 45;
            var headroom = 20;
            var footroom = 20;
            var rightroom = 20;

            var x = d3.time.scale()
                .range([0, w])
            var y = d3.scale.log()
                .range([h, 0])

            var xAxis = d3.svg.axis()
                 .scale(x)
                 .tickFormat(d3.time.format("%H:%M"));

            var yAxis = d3.svg.axis()
                 .scale(y)
                 .orient("left")
                 .tickFormat(function (d) { if (d.toString().match(/^\d/)[0] == "1")
                                                 return d3.format("s")(d)+"B/s"
                                            return "";
                                        })

			var svg = d3.select("svg")
						.attr("width", leftroom+w+rightroom)
						.attr("height", headroom+h+footroom);
            var plot = svg.append("g")
                        .attr("transform", "translate("+leftroom+","+headroom+")")
                        .attr("id", "plot")

            svg.append("text")
                .attr("transform", "translate("+String(leftroom + (w/2))+",15)")
                .attr("class", "label")
                .attr("text-anchor", "middle")
                .append("tspan")
                    .text("Maximum bandwidth vs. time, for ")
                .append("tspan")
                    .attr("class", "up")
                    .style("opacity", 1)
                    .text("uploads")
                .append("tspan")
                    .style("fill", "black")
                    .style("stroke", "none")
                    .text(" and ")
                .append("tspan")
                    .attr("class", "dn")
                    .style("opacity", 1)
                    .text("downloads")
                .append("tspan")
                    .style("fill", "black")
                    .style("stroke", "none")
                    .text(", per foreign host (connected by ")
                .append("tspan")
                    .style("font-weight", "bold")
                    .text("line")
                .append("tspan")
                    .style("font-weight", "normal")
                    .text(", IP on hover)")

            var axes_done = false;

            d3.selectAll("#subnet_controls input[name=mode]").on("change", function() {
                reeval(this.value);
            })

            //Map
            var projection = d3.geo.equirectangular()
                .translate([210, 110])
                .scale(75);

            var path = d3.geo.path()
                .projection(projection);

            var map = d3.select("body").append("svg")
                .attr("width", w+leftroom+rightroom)
                .attr("height", 190)
            .append("g")
                .attr("transform", "translate("+(w+ leftroom - 450)+",0)")
                .attr("id", "map")

            d3.json("world-110m2.json", function(error, topology) {
                map.selectAll("path")
                      .data(topojson.object(topology, topology.objects.countries)
                            .geometries)
                    .enter()
                      .append("path")
                      .attr("d", path)
            });

            var geoIPtable = {};
            d3.json(geoIPfile, function(err, json){
                geoIPtable = json.geoIPs;
                populateMap();
            })

            function populateMap(ips){

                function addToMap(ip){
                    var loc = geoIPtable[ip];
                    if (loc){
                        var proj = projection(loc);
                        if (isNaN(proj[0])){
                        }else{
                            map.append("circle")
                                .attr("cx", proj[0])
                                .attr("cy", proj[1])
                                .attr("r", 1)
                            }
                    }
                }

                if (ips){
                }else{
                    for (var key in geoIPtable) {
                        if (geoIPtable.hasOwnProperty(key)) {
                            addToMap(key);
                        }
                    }
                }

            }



            reeval("32"); //on startup
            function reeval(mask){
                d3.csv(datafile+mask+".csv")
                    .row(function(d) { return { ip: d.ip
                                              , up: +d.up
                                              , upt: new Date(1000* +d.upt)
                                              , dn: +d.dn
                                              , dnt: new Date(1000* +d.dnt)
                                              } })
                    .get(function(error, rows) {
                            var minDate = new Date("Jan 1 1970")
                            x.domain([d3.min(rows, function(d){ if (d.upt < minDate){
                                                                    return d.dnt < minDate ? undefined : d.dnt
                                                                }else{
                                                                    return d.dnt < minDate ? d.upt : Math.min(d.upt, d.dnt)
                                                                }})
                                     ,d3.max(rows, function(d){ return Math.max(d.upt, d.dnt) })])
                            y.domain([10, d3.max(rows, function(d){ return Math.max(d.up, d.dn) })])

                            svg.selectAll(".vary").remove();

                            plot.selectAll(".connect")
                                .data(rows)
                                .enter()
                                .append("line")
                                .attr("class", "connect vary")
                                .filter(function (d) {return d.up != 0 && d.dn != 0;})
                                .attr("x1", function(d) { return x(d.upt) })
                                .attr("x2", function(d) { return x(d.dnt) })
                                .attr("y1", function(d) { return y(d.up) })
                                .attr("y2", function(d) { return y(d.dn) })

                            plot.selectAll(".up")
                                .data(rows)
                                .enter()
                                .append("circle")
                                .attr("class", "up vary")
                                .filter(function (d) {return d.up != 0})
                                .attr("cx", function(d) { return x(d.upt) })
                                .attr("cy", function(d) { return y(d.up) })
                                .attr("r", 2)
                                .append("svg:title")
                                .text(function(d) { return mask == "32" ? d.ip : d.ip+"/"+mask; })

                            plot.selectAll(".dn")
                                .data(rows)
                                .enter()
                                .append("circle")
                                .attr("class", "dn vary")
                                .filter(function (d) {return d.dn != 0})
                                .attr("cx", function(d) { return x(d.dnt) })
                                .attr("cy", function(d) { return y(d.dn) })
                                .attr("r", 2)
                                .append("svg:title")
                                .text(function(d) { return mask == "32" ? d.ip : d.ip+"/"+mask; })

                            if (!axes_done){
                                axes_done = true;
                                svg.append("g")
                                    .attr("class", "x axis")
                                    .attr("transform", "translate("+leftroom+","+ String(headroom+h) +")")
                                    .call(xAxis);
                                svg.append("g")
                                    .attr("class", "y axis")
                                    .attr("transform", "translate("+leftroom+","+ headroom +")")
                                    .call(yAxis);
                            }

                            d3.json(densityfile+mask+".json", function(error, data){
                                var xDen = d3.scale.log()
                                            .domain([1, data.max])
                                            .range([leftroom, 1]);

                                var offset = (y(10) - y(100))*data.rez*0.5; // half the width of a sample
                                var line = d3.svg.line()
                                    .x(function(d) {return xDen(d[1])})
                                    .y(function(d) {return y(d[0]) + headroom + offset})
                                    //.interpolate("cardinal")

                                svg.append("path")
                                   .attr("class", "up vary")
                                   .attr("d", line(data.up));

                                svg.append("path")
                                   .attr("class", "dn vary")
                                   .attr("d", line(data.dn));

                            });

                        });
                    }

		</script>
	</body>
</html>
